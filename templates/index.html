{% extends "base.html" %}

{% block title %}Anihour - Current Season Anime{% endblock %}

{% block content %}
<!-- Hero Section -->
<div class="hero-section">
    <!-- Background Slideshow -->
    <div class="hero-slideshow" id="heroSlideshow">
        <!-- Images will be loaded dynamically -->
    </div>
    <div class="container">
        <div class="row align-items-center">
            <div class="col-lg-8 col-md-12">
                <h1 class="hero-title mb-4">
                    Welcome to <span class="brand-highlight">Anihour</span>
                </h1>
                <p class="hero-subtitle mb-4">
                    Your ultimate destination for discovering amazing anime series, tracking favorites, and staying updated with the latest releases.
                </p>
                <div class="hero-buttons">
                    <a href="/top" class="btn btn-primary btn-lg me-3 mb-2">
                        <i class="fas fa-trophy me-2"></i>Explore Top Anime
                    </a>
                    <a href="/upcoming" class="btn btn-outline-light btn-lg mb-2">
                        <i class="fas fa-clock me-2"></i>See Upcoming
                    </a>
                </div>
            </div>
            <div class="col-lg-4 col-md-12">
                <div class="hero-image-placeholder">
                    <i class="fas fa-play-circle hero-icon"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Stats Section -->
<div class="stats-section">
    <div class="container">
        <div class="row g-4">
            <div class="col-lg-3 col-md-6">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-tv"></i>
                    </div>
                    <div class="stat-content">
                        <h3>Current Season</h3>
                        <p>Latest airing anime</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stat-card">
                    <div class="stat-icon secondary">
                        <i class="fas fa-trophy"></i>
                    </div>
                    <div class="stat-content">
                        <h3>Top Rated</h3>
                        <p>Best anime of all time</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stat-card">
                    <div class="stat-icon accent">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-content">
                        <h3>Upcoming</h3>
                        <p>Future releases</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="stat-card">
                    <div class="stat-icon warning">
                        <i class="fas fa-fire"></i>
                    </div>
                    <div class="stat-content">
                        <h3>Trending</h3>
                        <p>Popular right now</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <!-- Search Results Section (Hidden by default) -->
    <div id="searchResults" class="search-results-section"></div>
    
    <!-- Current Season Anime Section -->
    <section class="content-section">
        <div class="section-header">
            <h2 class="section-title">
                <i class="fas fa-tv me-3"></i>Current Season
            </h2>
            <p class="section-description">Discover the hottest anime series airing right now</p>
            <a href="/" class="btn btn-outline-primary btn-sm">View All</a>
        </div>
        <div id="currentSeasonAnime">
            <div class="loading-state">
                <div class="loading-spinner"></div>
                <p>Loading current season anime...</p>
            </div>
        </div>
    </section>

    <!-- Top Anime Section -->
    <section class="content-section">
        <div class="section-header">
            <h2 class="section-title">
                <i class="fas fa-trophy me-3"></i>Top Rated Anime
            </h2>
            <p class="section-description">The highest-rated anime series of all time</p>
            <a href="/top" class="btn btn-outline-primary btn-sm">View All</a>
        </div>
        <div id="topAnimeSection">
            <div class="loading-state">
                <div class="loading-spinner"></div>
                <p>Loading top anime...</p>
            </div>
        </div>
    </section>

    <!-- Upcoming Anime Section -->
    <section class="content-section">
        <div class="section-header">
            <h2 class="section-title">
                <i class="fas fa-clock me-3"></i>Upcoming Releases
            </h2>
            <p class="section-description">Get ready for the next big anime releases</p>
            <a href="/upcoming" class="btn btn-outline-primary btn-sm">View All</a>
        </div>
        <div id="upcomingAnimeSection">
            <div class="loading-state">
                <div class="loading-spinner"></div>
                <p>Loading upcoming anime...</p>
            </div>
        </div>
    </section>
</div>

<!-- Decorative Background Pattern -->
<div class="position-fixed w-100 h-100" style="top: 0; left: 0; z-index: -2; opacity: 0.03;">
    <div class="bg-pattern h-100"></div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Hero Background Slideshow
    let slideshowImages = [];
    let currentSlideIndex = 0;
    
    async function loadHeroSlideshow() {
        try {
            console.log('Loading hero slideshow images...');
            const response = await fetch('/api/hero-slideshow-images');
            const data = await response.json();
            
            console.log('Slideshow API response:', data);
            
            if (data.images && data.images.length > 0) {
                slideshowImages = data.images;
                console.log(`Found ${slideshowImages.length} images for slideshow`);
                initializeSlideshow();
            } else {
                console.warn('No slideshow images found');
            }
        } catch (error) {
            console.error('Error loading slideshow images:', error);
        }
    }
    
    function initializeSlideshow() {
        const slideshowContainer = document.getElementById('heroSlideshow');
        if (!slideshowContainer) {
            console.error('Slideshow container not found');
            return;
        }
        
        console.log('Initializing slideshow with container:', slideshowContainer);
        
        // Create image elements
        slideshowImages.forEach((imageData, index) => {
            const img = document.createElement('img');
            img.src = `/api/image-proxy?url=${encodeURIComponent(imageData.image_url)}`;
            img.alt = imageData.title;
            img.className = `hero-slideshow-image${index === 0 ? ' active' : ''}`;
            img.loading = 'eager'; // Load first few images immediately
            
            console.log(`Creating slideshow image ${index + 1}:`, imageData.title, img.src);
            
            // Handle image load success
            img.onload = function() {
                console.log('Slideshow image loaded successfully:', imageData.title);
                this.style.display = 'block';
            };
            
            // Handle image load errors
            img.onerror = function() {
                console.error('Failed to load slideshow image:', imageData.title, this.src);
                // Try direct URL as fallback
                if (!this.src.includes('api/image-proxy')) {
                    console.log('Trying direct image URL as fallback');
                    this.src = imageData.image_url;
                } else {
                    this.remove();
                }
            };
            
            slideshowContainer.appendChild(img);
        });
        
        console.log(`Added ${slideshowImages.length} images to slideshow`);
        
        // Start slideshow if we have images
        if (slideshowImages.length > 1) {
            console.log('Starting slideshow timer');
            setInterval(nextSlide, 5000); // Change image every 5 seconds
        } else if (slideshowImages.length === 1) {
            console.log('Single image slideshow initialized');
        }
    }
    
    function nextSlide() {
        const images = document.querySelectorAll('.hero-slideshow-image');
        if (images.length === 0) {
            console.warn('No slideshow images found for transition');
            return;
        }
        
        console.log(`Transitioning from slide ${currentSlideIndex} to next slide`);
        
        // Remove active class from current image
        images[currentSlideIndex].classList.remove('active');
        
        // Move to next image
        currentSlideIndex = (currentSlideIndex + 1) % images.length;
        
        // Add active class to new image
        images[currentSlideIndex].classList.add('active');
        
        console.log(`Now showing slide ${currentSlideIndex}: ${images[currentSlideIndex].alt}`);
    }
    
    // Load slideshow immediately
    loadHeroSlideshow();

    // Enhanced animations for the new homepage design
    
    // Animate stat cards on scroll
    const statCards = document.querySelectorAll('.stat-card');
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.style.transform = 'translateY(0)';
                entry.target.style.opacity = '1';
            }
        });
    }, { threshold: 0.1 });
    
    statCards.forEach((card, index) => {
        card.style.transform = 'translateY(30px)';
        card.style.opacity = '0';
        card.style.transition = `all 0.6s ease ${index * 0.15}s`;
        observer.observe(card);
    });
    
    // Animate content sections on scroll
    const contentSections = document.querySelectorAll('.content-section');
    const sectionObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.classList.add('animate-in');
            }
        });
    }, { threshold: 0.1, rootMargin: '50px' });
    
    contentSections.forEach(section => {
        section.style.opacity = '0';
        section.style.transform = 'translateY(40px)';
        section.style.transition = 'all 0.8s ease';
        sectionObserver.observe(section);
    });

    // Add CSS for animate-in class
    const style = document.createElement('style');
    style.textContent = `
        .animate-in {
            opacity: 1 !important;
            transform: translateY(0) !important;
        }
    `;
    document.head.appendChild(style);

    // Enhanced button hover effects
    const buttons = document.querySelectorAll('.btn');
    buttons.forEach(btn => {
        btn.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-3px) scale(1.02)';
        });
        
        btn.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0) scale(1)';
        });
    });

    // Add click effects to stat cards (navigate to respective pages)
    statCards.forEach((card, index) => {
        card.style.cursor = 'pointer';
        card.addEventListener('click', function() {
            const routes = ['/', '/top', '/upcoming', '/news'];
            if (routes[index]) {
                window.location.href = routes[index];
            }
        });
    });

    // Parallax effect for hero section
    const hero = document.querySelector('.hero-section');
    if (hero) {
        window.addEventListener('scroll', () => {
            const scrolled = window.pageYOffset;
            const rate = scrolled * -0.5;
            if (scrolled <= hero.offsetHeight) {
                hero.style.transform = `translateY(${rate}px)`;
            }
        });
    }

    // Staggered animation for anime cards when they load
    const observeAnimeCards = () => {
        const animeCards = document.querySelectorAll('.anime-card');
        animeCards.forEach((card, index) => {
            card.style.opacity = '0';
            card.style.transform = 'translateY(20px)';
            
            setTimeout(() => {
                card.style.transition = 'all 0.6s ease';
                card.style.opacity = '1';
                card.style.transform = 'translateY(0)';
            }, index * 100);
        });
    };

    // Watch for content changes in sections
    const sectionContainers = ['currentSeasonAnime', 'topAnimeSection', 'upcomingAnimeSection'];
    sectionContainers.forEach(containerId => {
        const container = document.getElementById(containerId);
        if (container) {
            const contentObserver = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                        const hasAnimeGrid = Array.from(mutation.addedNodes).some(node => 
                            node.nodeType === Node.ELEMENT_NODE && node.querySelector('.anime-grid')
                        );
                        if (hasAnimeGrid) {
                            setTimeout(observeAnimeCards, 200);
                        }
                    }
                });
            });
            contentObserver.observe(container, { childList: true, subtree: true });
        }
    });
});
</script>
{% endblock %}
