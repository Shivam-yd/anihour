{% extends "base.html" %}

{% block title %}Top Rated Anime {{ current_year }} - Best Anime Series of All Time | Anihour{% endblock %}

{% block description %}Discover the highest-rated anime series of all time. Browse top-rated TV shows, movies, and OVAs with scores from MyAnimeList community. Find your next favorite anime series.{% endblock %}

{% block keywords %}top anime {{ current_year }}, best anime series, highest rated anime, top anime movies, anime rankings, MyAnimeList top anime, best anime of all time{% endblock %}

{% block structured_data %}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "CollectionPage",
  "name": "Top Rated Anime of All Time",
  "description": "The highest-rated anime series and movies according to MyAnimeList community ratings",
  "url": "{{ url_for('top_anime', _external=True) }}",
  "mainEntity": {
    "@type": "ItemList",
    "name": "Top Anime Rankings",
    "description": "Best anime series ranked by community ratings",
    "numberOfItems": "25+"
  },
  "breadcrumb": {
    "@type": "BreadcrumbList",
    "itemListElement": [
      {
        "@type": "ListItem",
        "position": 1,
        "name": "Home",
        "item": "{{ url_for('index', _external=True) }}"
      },
      {
        "@type": "ListItem",
        "position": 2,
        "name": "Top Anime",
        "item": "{{ url_for('top_anime', _external=True) }}"
      }
    ]
  }
}
</script>
{% endblock %}

{% block content %}
<!-- Hero Section -->
<div class="hero-section">
    <!-- Background Slideshow -->
    <div class="hero-slideshow" id="heroSlideshow">
        <!-- Images will be loaded dynamically -->
    </div>
    <div class="container">
        <div class="row align-items-center">
            <div class="col-lg-8 col-md-12">
                <h1 class="hero-title mb-4">
                    <i class="fas fa-trophy me-3"></i>Top Rated Anime
                </h1>
                <p class="hero-subtitle mb-4">
                    Discover the highest-rated anime series of all time, ranked by fans and critics worldwide.
                </p>
                <div class="hero-buttons">
                    <a href="/" class="btn btn-primary btn-lg me-3 mb-2">
                        <i class="fas fa-home me-2"></i>Browse Current
                    </a>
                    <a href="/upcoming" class="btn btn-outline-light btn-lg mb-2">
                        <i class="fas fa-clock me-2"></i>See Upcoming
                    </a>
                </div>
            </div>
            <div class="col-lg-4 col-md-12">
                <div class="hero-image-placeholder" id="heroImageBox">
                    <div class="hero-current-anime" id="heroCurrentAnime">
                        <img id="heroAnimeImage" class="hero-anime-img" alt="Current Anime" style="display: none;">
                        <div class="hero-anime-overlay">
                            <i class="fas fa-play-circle hero-icon"></i>
                            <div class="hero-anime-info">
                                <h4 id="heroAnimeTitle" class="hero-anime-title"></h4>
                                <p id="heroAnimeType" class="hero-anime-type"></p>
                            </div>
                        </div>
                        <div class="hero-loading">
                            <i class="fas fa-play-circle hero-icon"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <!-- Filter Buttons -->
    <div class="filter-buttons">
        <button class="filter-btn active" data-type="tv">
            <i class="fas fa-tv me-2"></i>TV Series
        </button>
        <button class="filter-btn" data-type="movie">
            <i class="fas fa-film me-2"></i>Movies
        </button>
        <button class="filter-btn" data-type="ova">
            <i class="fas fa-play-circle me-2"></i>OVA
        </button>
        <button class="filter-btn" data-type="special">
            <i class="fas fa-star me-2"></i>Special
        </button>
    </div>
    
    <!-- Top Anime Content -->
    <div id="topAnimeContent" class="mb-5">
        <div class="loading">
            <div class="loading-spinner"></div>
            <p>Loading top anime...</p>
        </div>
    </div>
</div>

<!-- Decorative Background -->
<div class="position-fixed w-100 h-100" style="top: 0; left: 0; z-index: -2; opacity: 0.03;">
    <div class="bg-pattern h-100"></div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Hero Background Slideshow
    let slideshowImages = [];
    let currentSlideIndex = 0;
    
    async function loadHeroSlideshow() {
        try {
            console.log('Loading hero slideshow images...');
            const response = await fetch('/api/hero-slideshow-images');
            const data = await response.json();
            
            console.log('Slideshow API response:', data);
            
            if (data.images && data.images.length > 0) {
                slideshowImages = data.images;
                console.log(`Found ${slideshowImages.length} images for slideshow`);
                initializeSlideshow();
            } else {
                console.warn('No slideshow images found');
            }
        } catch (error) {
            console.error('Error loading slideshow images:', error);
        }
    }
    
    function initializeSlideshow() {
        const slideshowContainer = document.getElementById('heroSlideshow');
        
        if (!slideshowContainer) {
            console.error('Slideshow container not found');
            return;
        }
        
        console.log('Initializing professional slideshow');
        
        // Create image elements
        slideshowImages.forEach((imageData, index) => {
            const img = document.createElement('img');
            img.src = `/api/image-proxy?url=${encodeURIComponent(imageData.image_url)}`;
            img.alt = imageData.title;
            img.className = `hero-slideshow-image${index === 0 ? ' active' : ''}`;
            img.loading = index < 2 ? 'eager' : 'lazy';
            img.decoding = 'async';
            img.dataset.slideIndex = index;
            
            img.onload = function() {
                console.log(`Slideshow image ${index + 1} loaded:`, imageData.title);
            };
            
            img.onerror = function() {
                console.error('Failed to load slideshow image:', imageData.title);
                this.remove();
            };
            
            slideshowContainer.appendChild(img);
        });
        
        console.log(`Initialized slideshow with ${slideshowImages.length} images`);
        
        // Initialize hero anime box
        initializeHeroAnimeBox();
        
        // Start auto slideshow
        if (slideshowImages.length > 1) {
            startAutoSlide();
        }
    }
    
    function initializeHeroAnimeBox() {
        if (slideshowImages.length > 0) {
            updateHeroAnimeBox(0);
        }
        
        const heroBox = document.getElementById('heroImageBox');
        if (heroBox) {
            heroBox.addEventListener('click', () => {
                const currentAnime = slideshowImages[currentSlideIndex];
                if (currentAnime) {
                    searchAnimeForDetails(currentAnime.title);
                }
            });
        }
    }
    
    function updateHeroAnimeBox(index) {
        if (!slideshowImages[index]) {
            console.log('No slideshow image at index:', index);
            return;
        }
        
        const currentAnime = slideshowImages[index];
        const heroImg = document.getElementById('heroAnimeImage');
        const heroTitle = document.getElementById('heroAnimeTitle');
        const heroType = document.getElementById('heroAnimeType');
        const heroLoading = document.querySelector('.hero-loading');
        
        console.log('Updating hero anime box with:', currentAnime.title, 'at index:', index);
        
        if (heroImg && heroTitle && heroType) {
            heroImg.classList.remove('loaded');
            heroImg.style.display = 'none';
            if (heroLoading) {
                heroLoading.style.display = 'flex';
            }
            
            heroImg.src = `/api/image-proxy?url=${encodeURIComponent(currentAnime.image_url)}`;
            heroImg.alt = currentAnime.title;
            
            heroTitle.textContent = currentAnime.title;
            heroType.textContent = currentAnime.type === 'current' ? 'Current Season' : 'Top Anime';
            
            heroImg.onload = function() {
                console.log('Hero anime image loaded:', currentAnime.title);
                this.style.display = 'block';
                this.classList.add('loaded');
                if (heroLoading) {
                    heroLoading.style.display = 'none';
                }
            };
            
            heroImg.onerror = function() {
                console.error('Hero anime image failed to load:', currentAnime.title);
                if (heroLoading) {
                    heroLoading.style.display = 'flex';
                }
            };
        }
    }
    
    async function searchAnimeForDetails(title) {
        try {
            const response = await fetch(`/api/search?q=${encodeURIComponent(title)}&limit=1`);
            const data = await response.json();
            
            if (data.data && data.data.length > 0) {
                const animeId = data.data[0].mal_id;
                window.location.href = `/anime/${animeId}`;
            } else {
                window.open(`https://myanimelist.net/search/all?q=${encodeURIComponent(title)}`, '_blank');
            }
        } catch (error) {
            console.error('Error searching anime:', error);
            window.open(`https://myanimelist.net/search/all?q=${encodeURIComponent(title)}`, '_blank');
        }
    }
    
    let autoSlideInterval;
    
    function goToSlide(index) {
        const images = document.querySelectorAll('.hero-slideshow-image');
        
        if (images.length === 0 || index >= images.length) return;
        
        images[currentSlideIndex]?.classList.remove('active');
        
        currentSlideIndex = index;
        images[currentSlideIndex].classList.add('active');
        
        updateHeroAnimeBox(currentSlideIndex);
        
        restartAutoSlide();
    }
    
    function nextSlide() {
        goToSlide((currentSlideIndex + 1) % slideshowImages.length);
    }
    
    function startAutoSlide() {
        autoSlideInterval = setInterval(nextSlide, 6000);
        console.log('Auto slideshow started');
    }
    
    function restartAutoSlide() {
        if (autoSlideInterval) {
            clearInterval(autoSlideInterval);
            startAutoSlide();
        }
    }
    
    // Load slideshow immediately
    loadHeroSlideshow();
    
    console.log('Top anime page initialized');
    // Filter button functionality
    const filterButtons = document.querySelectorAll('.filter-btn');
    
    // Check URL parameters for type filter
    const urlParams = new URLSearchParams(window.location.search);
    const initialType = urlParams.get('type') || 'tv';
    
    
    // Set active button based on URL parameter
    setActiveButton(initialType);
    
    // Load initial data based on URL parameter
    loadInitialData(initialType);
    
    filterButtons.forEach(button => {
        button.addEventListener('click', async function() {
            // Update active button
            filterButtons.forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            
            // Get selected type
            const selectedType = this.dataset.type;
            
            // Show loading
            const container = document.getElementById('topAnimeContent');
            container.innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>Loading ${selectedType.toUpperCase()} anime...</p>
                </div>
            `;
            
            // Fetch filtered data
            try {
                const response = await fetch(`/api/top-anime?type=${selectedType}`);
                const data = await response.json();
                
                if (response.ok && data.data) {
                    displayFilteredAnime(data.data, selectedType);
                } else {
                    showError('Failed to load filtered anime');
                }
            } catch (error) {
                console.error('Filter error:', error);
                showError('Network error occurred');
            }
        });
    });
    
    function displayFilteredAnime(animeList, type) {
        const container = document.getElementById('topAnimeContent');
        const typeLabels = {
            'tv': 'TV Series',
            'movie': 'Movies',
            'ova': 'OVA',
            'special': 'Special'
        };
        
        const html = `
            <div class="section-header">
                <h2 class="section-title">Top ${typeLabels[type]}</h2>
                <p class="section-subtitle">Highest rated ${typeLabels[type].toLowerCase()}</p>
            </div>
            <div class="anime-grid">
                ${animeList.map((anime, index) => createTopAnimeCard(anime, index + 1)).join('')}
            </div>
        `;
        
        container.innerHTML = html;
        setupAnimeCardEvents();
    }
    
    function createTopAnimeCard(anime, rank) {
        const rating = anime.score ? anime.score.toFixed(1) : 'N/A';
        
        // Use image proxy for proper image loading
        let image = '';
        if (anime.images && anime.images.jpg) {
            const originalImage = anime.images.jpg.large_image_url || anime.images.jpg.image_url || anime.images.jpg.small_image_url;
            if (originalImage && originalImage.startsWith('https://cdn.myanimelist.net/')) {
                image = `/api/image-proxy?url=${encodeURIComponent(originalImage)}`;
            } else {
                image = originalImage;
            }
        }
        
        // Use placeholder if no valid image found
        if (!image) {
            image = `data:image/svg+xml;charset=UTF-8,%3csvg width='300' height='400' xmlns='http://www.w3.org/2000/svg'%3e%3cdefs%3e%3clinearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3e%3cstop offset='0%25' style='stop-color:%23667eea;stop-opacity:1' /%3e%3cstop offset='100%25' style='stop-color:%23764ba2;stop-opacity:1' /%3e%3c/linearGradient%3e%3c/defs%3e%3crect width='300' height='400' fill='url(%23grad)'/%3e%3ctext x='50%25' y='45%25' font-family='Arial, sans-serif' font-size='16' fill='white' text-anchor='middle' dy='.3em'%3e📺%3c/text%3e%3ctext x='50%25' y='60%25' font-family='Arial, sans-serif' font-size='12' fill='white' text-anchor='middle' dy='.3em'%3eAnime Image%3c/text%3e%3c/svg%3e`;
        }
        
        const synopsis = anime.synopsis ? truncateText(anime.synopsis, 150) : 'No synopsis available.';
        
        return `
            <div class="anime-card position-relative" data-anime-id="${anime.mal_id}">
                <div class="position-absolute top-0 start-0 m-3 bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" 
                     style="width: 40px; height: 40px; font-weight: bold; z-index: 2;">
                    #${rank}
                </div>
                <div class="anime-card-image-container">
                    <img src="${image}" 
                         alt="${anime.title}" 
                         class="anime-card-img" 
                         loading="lazy"
                         onerror="console.error('Top anime image failed to load:', this.src); this.src='data:image/svg+xml;charset=UTF-8,%3csvg width=\\'300\\' height=\\'400\\' xmlns=\\'http://www.w3.org/2000/svg\\'%3e%3cdefs%3e%3clinearGradient id=\\'grad\\' x1=\\'0%25\\' y1=\\'0%25\\' x2=\\'100%25\\' y2=\\'100%25\\'%3e%3cstop offset=\\'0%25\\' style=\\'stop-color:%23667eea;stop-opacity:1\\' /%3e%3cstop offset=\\'100%25\\' style=\\'stop-color:%23764ba2;stop-opacity:1\\' /%3e%3c/linearGradient%3e%3c/defs%3e%3crect width=\\'300\\' height=\\'400\\' fill=\\'url(%23grad)\\'/%3e%3ctext x=\\'50%25\\' y=\\'45%25\\' font-family=\\'Arial, sans-serif\\' font-size=\\'16\\' fill=\\'white\\' text-anchor=\\'middle\\' dy=\\'.3em\\'%3e📺%3c/text%3e%3ctext x=\\'50%25\\' y=\\'60%25\\' font-family=\\'Arial, sans-serif\\' font-size=\\'12\\' fill=\\'white\\' text-anchor=\\'middle\\' dy=\\'.3em\\'%3eImage Not Found%3c/text%3e%3c/svg%3e'; this.onerror=null; this.setAttribute('data-loaded', 'true'); this.style.opacity='1'; this.parentElement.classList.add('loaded');"
                         onload="console.log('Top anime image loaded:', this.alt); this.setAttribute('data-loaded', 'true'); this.style.opacity='1'; this.parentElement.classList.add('loaded');">
                    <div class="anime-card-overlay">
                        <i class="fas fa-play-circle"></i>
                    </div>
                </div>
                <div class="anime-card-body">
                    <h3 class="anime-card-title">${anime.title || 'Unknown Title'}</h3>
                    <div class="anime-card-info">
                        <span class="anime-rating">★ ${rating}</span>
                        <span class="badge bg-info">${anime.type || 'Unknown'}</span>
                    </div>
                    <p class="anime-synopsis">${synopsis}</p>
                </div>
            </div>
        `;
    }
    
    function setupAnimeCardEvents() {
        const animeCards = document.querySelectorAll('.anime-card');
        animeCards.forEach(card => {
            card.addEventListener('click', () => {
                const animeId = card.dataset.animeId;
                if (animeId) {
                    window.location.href = `/anime/${animeId}`;
                }
            });
        });
    }
    
    function showError(message) {
        const container = document.getElementById('topAnimeContent');
        container.innerHTML = `
            <div class="error-message">
                <div class="error-title">Oops! Something went wrong</div>
                <p>${message}</p>
                <button class="btn btn-primary" onclick="location.reload()">Try Again</button>
            </div>
        `;
    }
    
    function truncateText(text, length) {
        if (!text) return '';
        return text.length > length ? text.substring(0, length) + '...' : text;
    }
    
    // Set active button based on type
    function setActiveButton(type) {
        filterButtons.forEach(btn => btn.classList.remove('active'));
        const activeButton = document.querySelector(`[data-type="${type}"]`);
        if (activeButton) {
            activeButton.classList.add('active');
        }
    }
    
    // Load initial data based on type parameter
    async function loadInitialData(type = 'tv') {
        try {
            const response = await fetch(`/api/top-anime?type=${type}`);
            const data = await response.json();
            
            if (response.ok && data.data) {
                displayFilteredAnime(data.data, type);
            } else {
                showError(`Failed to load top ${type} anime`);
            }
        } catch (error) {
            console.error('Initial load error:', error);
            showError('Network error occurred');
        }
    }
});
</script>
{% endblock %}
