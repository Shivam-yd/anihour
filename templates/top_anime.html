{% extends "base.html" %}

{% block title %}Top Anime - Anihour{% endblock %}

{% block content %}
<div class="hero-section">
    <div class="container">
        <h1 class="hero-title">
            <i class="fas fa-trophy me-3"></i>
            Top Rated Anime
        </h1>
        <p class="hero-subtitle">
            Discover the highest-rated anime series of all time
        </p>
    </div>
</div>

<div class="container">
    <!-- Filter Buttons -->
    <div class="filter-buttons">
        <button class="filter-btn active" data-type="tv">
            <i class="fas fa-tv me-2"></i>TV Series
        </button>
        <button class="filter-btn" data-type="movie">
            <i class="fas fa-film me-2"></i>Movies
        </button>
        <button class="filter-btn" data-type="ova">
            <i class="fas fa-play-circle me-2"></i>OVA
        </button>
        <button class="filter-btn" data-type="special">
            <i class="fas fa-star me-2"></i>Special
        </button>
    </div>
    
    <!-- Top Anime Content -->
    <div id="topAnimeContent" class="mb-5">
        <div class="loading">
            <div class="loading-spinner"></div>
            <p>Loading top anime...</p>
        </div>
    </div>
</div>

<!-- Decorative Background -->
<div class="position-fixed w-100 h-100" style="top: 0; left: 0; z-index: -2; opacity: 0.03;">
    <div class="bg-pattern h-100"></div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Filter button functionality
    const filterButtons = document.querySelectorAll('.filter-btn');
    
    // Check URL parameters for type filter
    const urlParams = new URLSearchParams(window.location.search);
    const initialType = urlParams.get('type') || 'tv';
    
    
    // Set active button based on URL parameter
    setActiveButton(initialType);
    
    // Load initial data based on URL parameter
    loadInitialData(initialType);
    
    filterButtons.forEach(button => {
        button.addEventListener('click', async function() {
            // Update active button
            filterButtons.forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            
            // Get selected type
            const selectedType = this.dataset.type;
            
            // Show loading
            const container = document.getElementById('topAnimeContent');
            container.innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>Loading ${selectedType.toUpperCase()} anime...</p>
                </div>
            `;
            
            // Fetch filtered data
            try {
                const response = await fetch(`/api/top-anime?type=${selectedType}`);
                const data = await response.json();
                
                if (response.ok && data.data) {
                    displayFilteredAnime(data.data, selectedType);
                } else {
                    showError('Failed to load filtered anime');
                }
            } catch (error) {
                console.error('Filter error:', error);
                showError('Network error occurred');
            }
        });
    });
    
    function displayFilteredAnime(animeList, type) {
        const container = document.getElementById('topAnimeContent');
        const typeLabels = {
            'tv': 'TV Series',
            'movie': 'Movies',
            'ova': 'OVA',
            'special': 'Special'
        };
        
        const html = `
            <div class="section-header">
                <h2 class="section-title">Top ${typeLabels[type]}</h2>
                <p class="section-subtitle">Highest rated ${typeLabels[type].toLowerCase()}</p>
            </div>
            <div class="anime-grid">
                ${animeList.map((anime, index) => createTopAnimeCard(anime, index + 1)).join('')}
            </div>
        `;
        
        container.innerHTML = html;
        setupAnimeCardEvents();
    }
    
    function createTopAnimeCard(anime, rank) {
        const rating = anime.score ? anime.score.toFixed(1) : 'N/A';
        
        // Use image proxy for proper image loading
        let image = '';
        if (anime.images && anime.images.jpg) {
            const originalImage = anime.images.jpg.large_image_url || anime.images.jpg.image_url || anime.images.jpg.small_image_url;
            if (originalImage && originalImage.startsWith('https://cdn.myanimelist.net/')) {
                image = `/api/image-proxy?url=${encodeURIComponent(originalImage)}`;
            } else {
                image = originalImage;
            }
        }
        
        // Use placeholder if no valid image found
        if (!image) {
            image = `data:image/svg+xml;charset=UTF-8,%3csvg width='300' height='400' xmlns='http://www.w3.org/2000/svg'%3e%3cdefs%3e%3clinearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3e%3cstop offset='0%25' style='stop-color:%23667eea;stop-opacity:1' /%3e%3cstop offset='100%25' style='stop-color:%23764ba2;stop-opacity:1' /%3e%3c/linearGradient%3e%3c/defs%3e%3crect width='300' height='400' fill='url(%23grad)'/%3e%3ctext x='50%25' y='45%25' font-family='Arial, sans-serif' font-size='16' fill='white' text-anchor='middle' dy='.3em'%3eðŸ“º%3c/text%3e%3ctext x='50%25' y='60%25' font-family='Arial, sans-serif' font-size='12' fill='white' text-anchor='middle' dy='.3em'%3eAnime Image%3c/text%3e%3c/svg%3e`;
        }
        
        const synopsis = anime.synopsis ? truncateText(anime.synopsis, 150) : 'No synopsis available.';
        
        return `
            <div class="anime-card position-relative" data-anime-id="${anime.mal_id}">
                <div class="position-absolute top-0 start-0 m-3 bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" 
                     style="width: 40px; height: 40px; font-weight: bold; z-index: 2;">
                    #${rank}
                </div>
                <div class="anime-card-image-container">
                    <img src="${image}" 
                         alt="${anime.title}" 
                         class="anime-card-img" 
                         loading="lazy"
                         onerror="console.error('Top anime image failed to load:', this.src); this.src='data:image/svg+xml;charset=UTF-8,%3csvg width=\\'300\\' height=\\'400\\' xmlns=\\'http://www.w3.org/2000/svg\\'%3e%3cdefs%3e%3clinearGradient id=\\'grad\\' x1=\\'0%25\\' y1=\\'0%25\\' x2=\\'100%25\\' y2=\\'100%25\\'%3e%3cstop offset=\\'0%25\\' style=\\'stop-color:%23667eea;stop-opacity:1\\' /%3e%3cstop offset=\\'100%25\\' style=\\'stop-color:%23764ba2;stop-opacity:1\\' /%3e%3c/linearGradient%3e%3c/defs%3e%3crect width=\\'300\\' height=\\'400\\' fill=\\'url(%23grad)\\'/%3e%3ctext x=\\'50%25\\' y=\\'45%25\\' font-family=\\'Arial, sans-serif\\' font-size=\\'16\\' fill=\\'white\\' text-anchor=\\'middle\\' dy=\\'.3em\\'%3eðŸ“º%3c/text%3e%3ctext x=\\'50%25\\' y=\\'60%25\\' font-family=\\'Arial, sans-serif\\' font-size=\\'12\\' fill=\\'white\\' text-anchor=\\'middle\\' dy=\\'.3em\\'%3eImage Not Found%3c/text%3e%3c/svg%3e'; this.onerror=null; this.setAttribute('data-loaded', 'true'); this.style.opacity='1'; this.parentElement.classList.add('loaded');"
                         onload="console.log('Top anime image loaded:', this.alt); this.setAttribute('data-loaded', 'true'); this.style.opacity='1'; this.parentElement.classList.add('loaded');">
                    <div class="anime-card-overlay">
                        <i class="fas fa-play-circle"></i>
                    </div>
                </div>
                <div class="anime-card-body">
                    <h3 class="anime-card-title">${anime.title || 'Unknown Title'}</h3>
                    <div class="anime-card-info">
                        <span class="anime-rating">â˜… ${rating}</span>
                        <span class="badge bg-info">${anime.type || 'Unknown'}</span>
                    </div>
                    <p class="anime-synopsis">${synopsis}</p>
                </div>
            </div>
        `;
    }
    
    function setupAnimeCardEvents() {
        const animeCards = document.querySelectorAll('.anime-card');
        animeCards.forEach(card => {
            card.addEventListener('click', () => {
                const animeId = card.dataset.animeId;
                if (animeId) {
                    window.location.href = `/anime/${animeId}`;
                }
            });
        });
    }
    
    function showError(message) {
        const container = document.getElementById('topAnimeContent');
        container.innerHTML = `
            <div class="error-message">
                <div class="error-title">Oops! Something went wrong</div>
                <p>${message}</p>
                <button class="btn btn-primary" onclick="location.reload()">Try Again</button>
            </div>
        `;
    }
    
    function truncateText(text, length) {
        if (!text) return '';
        return text.length > length ? text.substring(0, length) + '...' : text;
    }
    
    // Set active button based on type
    function setActiveButton(type) {
        filterButtons.forEach(btn => btn.classList.remove('active'));
        const activeButton = document.querySelector(`[data-type="${type}"]`);
        if (activeButton) {
            activeButton.classList.add('active');
        }
    }
    
    // Load initial data based on type parameter
    async function loadInitialData(type = 'tv') {
        try {
            const response = await fetch(`/api/top-anime?type=${type}`);
            const data = await response.json();
            
            if (response.ok && data.data) {
                displayFilteredAnime(data.data, type);
            } else {
                showError(`Failed to load top ${type} anime`);
            }
        } catch (error) {
            console.error('Initial load error:', error);
            showError('Network error occurred');
        }
    }
});
</script>
{% endblock %}
